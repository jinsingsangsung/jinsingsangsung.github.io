---
import { ENABLE_LIGHTBOX } from "@/constants.ts";
import * as interfaces from "@/lib/interfaces.ts";
import { filePath, getFirstImage } from "@/lib/blog-helpers";
import Caption from "@/components/notion-blocks/Caption.astro";

export interface Props {
	block: interfaces.Block;
	setId?: boolean;
}

const { block, setId = true } = Astro.props;

let image = "";
if (block.NImage?.External) {
	image = block.NImage.External.Url;
} else if (block.NImage?.File) {
	image = filePath(new URL(block.NImage.File.OptimizedUrl));
}

const plainTextCaption = block.NImage?.Caption.map((richText) => richText.PlainText).join(" ");

// Debug Image block properties
const imageDebugData = {
	blockId: block.Id?.slice(-8),
	blockType: block.Type,
	allBlockProperties: Object.keys(block),
	nImageProperties: block.NImage ? Object.keys(block.NImage) : [],
	hasExternal: !!block.NImage?.External,
	hasFile: !!block.NImage?.File,
	imageType: block.NImage?.Type,
	caption: plainTextCaption
};
---

<!-- Image API Debug Display -->
<div style="background: #fff3e0; padding: 12px; margin: 12px 0; font-size: 11px; border: 2px solid #ff9800; border-radius: 4px; font-family: monospace;">
	<strong>üñºÔ∏è IMAGE BLOCK API DEBUG:</strong><br/>
	<div style="margin-top: 8px;">
		<strong>Block ID:</strong> {imageDebugData.blockId}<br/>
		<strong>Block Type:</strong> {imageDebugData.blockType}<br/>
		<strong>All Block Properties:</strong> [{imageDebugData.allBlockProperties.join(', ')}]<br/>
		<strong>NImage Properties:</strong> [{imageDebugData.nImageProperties.join(', ')}]<br/>
		<strong>Image Type:</strong> {imageDebugData.imageType}<br/>
		<strong>Has External:</strong> {imageDebugData.hasExternal}<br/>
		<strong>Has File:</strong> {imageDebugData.hasFile}<br/>
		<strong>Caption:</strong> {imageDebugData.caption || 'No caption'}
	</div>
</div>

{
	image && (
		<figure class="mx-auto mt-1 max-w-full" id={setId ? block.Id : undefined}>
			<div class="mx-auto min-w-0">
				{ENABLE_LIGHTBOX ? (
					<a
						data-type="image"
						href={image}
						class="mediaglightbox no-rss"
						data-description={plainTextCaption}
						aria-label={`Open image with alt ${plainTextCaption} in lightbox`}
					>
						<img
							class="imagemedia block max-w-full rounded-md"
							loading={getFirstImage() && setId ? "eager" : "lazy"}
							src={image}
							alt={plainTextCaption}
						/>
					</a>
				) : (
					<img
						class="imagemedia block max-w-full rounded-md"
						src={image}
						loading={getFirstImage() ? "eager" : "lazy"}
						alt={plainTextCaption}
					/>
				)}
			</div>
			<Caption richTexts={block.NImage.Caption} block={block} as="figcaption" />
		</figure>
	)
}
